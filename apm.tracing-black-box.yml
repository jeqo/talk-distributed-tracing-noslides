version: '3'
services:
  skywalking-webui:
    image: skywalking/skywalking-ui:3.2.6-2017
    expose:
      - "8080"
    ports:
      - "28080:8080"
    links:
      - skywalking-collector
    depends_on:
      - skywalking-collector
    environment:
      - COLLECTOR_SERVERS=skywalking-collector:10800

  skywalking-collector:
    image: skywalking/skywalking-collector:3.2.6-2017
    expose:
      - "10800"
      - "11800"
      - "12800"
    ports:
      - "12800:12800"
      - "11800:11800"
      - "10800:10800"
    depends_on:
      - skywalking-es-server
      - skywalking-zookeeper-server
    links:
      - skywalking-es-server
      - skywalking-zookeeper-server
    environment:
      - ZK_ADDRESSES=skywalking-zookeeper-server:2181
      - ES_ADDRESSES=skywalking-es-server:9300
      - BIND_HOST=0.0.0.0
      - AGENT_JETTY_BIND_HOST=skywalking-collector
      - NAMING_BIND_HOST=skywalking-collector
      - UI_JETTY_BIND_HOST=skywalking-collector
    healthcheck:
      test: ["CMD", "curl", "-f", "http://skywalking-collector:10800/agent/gRPC"]
      interval: 10s
      timeout: 10s
      retries: 5

  skywalking-zookeeper-server:
    image: zookeeper:3.4.9
    expose:
      - "2181"
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "/zookeeper-3.4.9/bin/zkServer.sh", "status"]
      interval: 10s
      timeout: 10s
      retries: 5

  skywalking-es-server:
    image: elasticsearch:5.3
    command: "-Enode.name=TestNode -Enetwork.host=0.0.0.0 -Ehttp.cors.enabled=true -Ehttp.cors.allow-origin=* -Ethread_pool.bulk.queue_size=1000 -Ecluster.name=CollectorDBCluster"
    environment:
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    expose:
      - "9200"
      - "9300"
    ports:
      - "9200:9200"
      - "9300:9300"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200"]
      interval: 10s
      timeout: 10s
      retries: 5

  ## Agent
  #skywalking-agent:
  #  image: skywalking/skywalking-agent:3.2.6-2017
    

